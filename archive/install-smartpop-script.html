<!DOCTYPE html>
<html>
<head>
    <title>Install SmartPop Script on Shopify Store</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
            background: #f8f9fa;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { color: #2c3e50; margin-bottom: 20px; }
        .status {
            padding: 16px;
            margin: 16px 0;
            border-radius: 8px;
            font-weight: 500;
        }
        .success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 4px solid #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left: 4px solid #ffc107; }
        
        .form-group {
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #495057;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 16px;
            font-family: monospace;
            box-sizing: border-box;
        }
        input:focus {
            outline: none;
            border-color: #007cba;
        }
        
        .button {
            background: #007cba;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px 8px 8px 0;
            transition: background-color 0.2s;
        }
        .button:hover { background: #005a8b; }
        .button.success { background: #28a745; }
        .button.success:hover { background: #1e7e34; }
        .button.warning { background: #ffc107; color: #212529; }
        .button.warning:hover { background: #e0a800; }
        .button.danger { background: #dc3545; }
        .button.danger:hover { background: #c82333; }
        
        code {
            background: #f1f3f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }
        pre {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 6px;
            overflow-x: auto;
            border-left: 4px solid #6c757d;
        }
        
        .script-info {
            background: #e7f3ff;
            border: 2px solid #007cba;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .step-list {
            counter-reset: step-counter;
            list-style: none;
            padding: 0;
        }
        .step-list li {
            counter-increment: step-counter;
            margin: 16px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            position: relative;
            padding-left: 50px;
        }
        .step-list li::before {
            content: counter(step-counter);
            position: absolute;
            left: 12px;
            top: 12px;
            background: #007cba;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        
        #results {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéØ SmartPop Script Installation</h1>
        
        <div class="info">
            <h3>Install SmartPop on Your Shopify Store</h3>
            <p>This tool will install the SmartPop script on <strong>testingstoresumeet.myshopify.com</strong> using Shopify's Script Tags API.</p>
        </div>

        <div class="script-info">
            <h4>üìÑ Script Details</h4>
            <p><strong>Script URL:</strong> <code id="script-url">https://zsmoutzjhqjgjehaituw.supabase.co/functions/v1/popup-embed-public?shop=testingstoresumeet.myshopify.com</code></p>
            <p><strong>Features:</strong></p>
            <ul>
                <li>‚úÖ Real-time popup configuration loading</li>
                <li>‚úÖ Scroll depth tracking and triggers</li>
                <li>‚úÖ Time-based popup triggers</li>
                <li>‚úÖ Admin detection and blocking</li>
                <li>‚úÖ Email capture and conversion tracking</li>
                <li>‚úÖ Mobile and desktop responsive popups</li>
            </ul>
        </div>

        <div class="warning">
            <h4>‚ö†Ô∏è Access Token Required</h4>
            <p>You need a Shopify access token with <code>write_script_tags</code> and <code>read_script_tags</code> permissions.</p>
            
            <div class="form-group">
                <label for="access-token">Shopify Access Token:</label>
                <input type="password" id="access-token" placeholder="Enter your Shopify access token">
                <small style="color: #6c757d;">This token will not be stored and is only used for the installation.</small>
            </div>
        </div>

        <div style="text-align: center; margin: 30px 0;">
            <button class="button" onclick="listScripts()">üìã List Current Scripts</button>
            <button class="button warning" onclick="removeOldScripts()">üóëÔ∏è Remove Old Scripts</button>
            <button class="button success" onclick="installScript()">üöÄ Install Script</button>
            <button class="button" onclick="testStore()">üåê Test Store</button>
        </div>

        <div id="results"></div>

        <div class="info" style="margin-top: 40px;">
            <h4>üìã Manual Installation Steps</h4>
            <ol class="step-list">
                <li>Go to your Shopify Admin ‚Üí Apps ‚Üí Develop apps (or App Development)</li>
                <li>Create a new app or select an existing one</li>
                <li>Configure Admin API access with permissions: <code>read_script_tags</code>, <code>write_script_tags</code></li>
                <li>Generate an access token and copy it</li>
                <li>Paste the token above and click "Install Script"</li>
                <li>Visit your store homepage to see the popups in action</li>
            </ol>
        </div>

        <div class="script-info">
            <h4>üß™ Testing Your Installation</h4>
            <p>After installation, visit <a href="https://testingstoresumeet.myshopify.com/" target="_blank">testingstoresumeet.myshopify.com</a> and:</p>
            <ul>
                <li>Open browser console (F12) to see SmartPop logs</li>
                <li>Scroll down to trigger scroll-based popups</li>
                <li>Wait 5 seconds for time-based popups</li>
                <li>Look for popup notifications and email capture forms</li>
            </ul>
        </div>
    </div>

    <script>
        const SHOP_DOMAIN = 'testingstoresumeet.myshopify.com';
        const SCRIPT_URL = 'https://zsmoutzjhqjgjehaituw.supabase.co/functions/v1/popup-embed-public?shop=testingstoresumeet.myshopify.com';
        const API_VERSION = '2023-10';

        function addResult(title, content, type = 'info') {
            const results = document.getElementById('results');
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = `<h4>${title}</h4><div>${content}</div>`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
        }

        function getAccessToken() {
            const token = document.getElementById('access-token').value.trim();
            if (!token) {
                addResult('‚ùå Access Token Required', 'Please enter your Shopify access token first.', 'error');
                return null;
            }
            return token;
        }

        async function listScripts() {
            const token = getAccessToken();
            if (!token) return;

            addResult('üîÑ Listing Scripts', 'Fetching current script tags...');

            try {
                const response = await fetch(`https://${SHOP_DOMAIN}/admin/api/${API_VERSION}/script_tags.json`, {
                    headers: { 'X-Shopify-Access-Token': token }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                const scripts = data.script_tags || [];

                let content = `<p>Found <strong>${scripts.length}</strong> script tags on the store:</p><ul>`;
                
                if (scripts.length === 0) {
                    content += '<li><em>No scripts found</em></li>';
                } else {
                    scripts.forEach((script, index) => {
                        const isSmartPop = script.src && (
                            script.src.includes('smartpop') ||
                            script.src.includes('popup-embed-public') ||
                            script.src.includes('popup-script')
                        );
                        const highlight = isSmartPop ? ' style="background: #fff3cd; padding: 4px; border-radius: 4px;"' : '';
                        
                        content += `<li${highlight}>
                            <strong>ID:</strong> ${script.id}<br>
                            <strong>Source:</strong> ${script.src ? script.src.substring(0, 80) + '...' : 'inline'}<br>
                            <strong>Event:</strong> ${script.event}<br>
                            <strong>Created:</strong> ${script.created_at}
                            ${isSmartPop ? '<br><strong style="color: #856404;">‚ö†Ô∏è SmartPop Script</strong>' : ''}
                        </li>`;
                    });
                }
                content += '</ul>';

                addResult('üìã Current Scripts', content, 'success');

                const smartPopScripts = scripts.filter(script => 
                    script.src && (
                        script.src.includes('smartpop') ||
                        script.src.includes('popup-embed-public') ||
                        script.src.includes('popup-script')
                    )
                );

                if (smartPopScripts.length > 0) {
                    addResult('üéØ SmartPop Scripts Found', 
                        `Found ${smartPopScripts.length} existing SmartPop scripts that should be removed before installing the new one.`, 
                        'warning');
                }

            } catch (error) {
                addResult('‚ùå Failed to List Scripts', error.message, 'error');
            }
        }

        async function removeOldScripts() {
            const token = getAccessToken();
            if (!token) return;

            addResult('üîÑ Removing Old Scripts', 'Finding and removing existing SmartPop scripts...');

            try {
                const response = await fetch(`https://${SHOP_DOMAIN}/admin/api/${API_VERSION}/script_tags.json`, {
                    headers: { 'X-Shopify-Access-Token': token }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${await response.text()}`);
                }

                const data = await response.json();
                const scripts = data.script_tags || [];

                const smartPopScripts = scripts.filter(script => 
                    script.src && (
                        script.src.includes('smartpop') ||
                        script.src.includes('popup-embed-public') ||
                        script.src.includes('popup-script')
                    )
                );

                if (smartPopScripts.length === 0) {
                    addResult('‚ÑπÔ∏è No Scripts to Remove', 'No existing SmartPop scripts found.', 'info');
                    return;
                }

                let removed = 0;
                for (const script of smartPopScripts) {
                    try {
                        const deleteResponse = await fetch(`https://${SHOP_DOMAIN}/admin/api/${API_VERSION}/script_tags/${script.id}.json`, {
                            method: 'DELETE',
                            headers: { 'X-Shopify-Access-Token': token }
                        });

                        if (deleteResponse.ok) {
                            removed++;
                            console.log('‚úÖ Removed script:', script.id);
                        } else {
                            console.log('‚ö†Ô∏è Failed to remove script:', script.id);
                        }
                    } catch (error) {
                        console.log('‚ùå Error removing script:', script.id, error.message);
                    }
                }

                addResult('‚úÖ Scripts Removed', 
                    `Successfully removed ${removed} out of ${smartPopScripts.length} SmartPop scripts.`, 
                    'success');

            } catch (error) {
                addResult('‚ùå Remove Error', error.message, 'error');
            }
        }

        async function installScript() {
            const token = getAccessToken();
            if (!token) return;

            addResult('üöÄ Installing Script', 'Installing SmartPop script on your store...');

            try {
                const scriptTag = {
                    script_tag: {
                        event: 'onload',
                        src: SCRIPT_URL,
                        display_scope: 'online_store'
                    }
                };

                const response = await fetch(`https://${SHOP_DOMAIN}/admin/api/${API_VERSION}/script_tags.json`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shopify-Access-Token': token
                    },
                    body: JSON.stringify(scriptTag)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const result = await response.json();
                
                const successContent = `
                    <p><strong>‚úÖ SmartPop script installed successfully!</strong></p>
                    <p><strong>Script Tag ID:</strong> ${result.script_tag.id}</p>
                    <p><strong>Source:</strong> <code>${result.script_tag.src}</code></p>
                    <p><strong>Event:</strong> ${result.script_tag.event}</p>
                    <p><strong>Created:</strong> ${result.script_tag.created_at}</p>
                    
                    <h4 style="margin-top: 20px;">üéØ What's Now Active:</h4>
                    <ul>
                        <li>‚úÖ Real-time popup loading from database</li>
                        <li>‚úÖ Scroll depth tracking and triggers</li>
                        <li>‚úÖ Time-based popup triggers (5-second delays)</li>
                        <li>‚úÖ Admin detection (won't show in Shopify admin)</li>
                        <li>‚úÖ Email capture and conversion tracking</li>
                        <li>‚úÖ Mobile responsive popup designs</li>
                    </ul>
                `;

                addResult('‚úÖ Installation Complete', successContent, 'success');

                const testContent = `
                    <h4>üß™ Test Your Installation:</h4>
                    <ol>
                        <li>Visit <a href="https://${SHOP_DOMAIN}/" target="_blank">${SHOP_DOMAIN}</a></li>
                        <li>Open browser console (F12) and look for SmartPop logs</li>
                        <li>Scroll down or wait 5 seconds for popups to appear</li>
                        <li>Test the email capture and discount codes</li>
                    </ol>
                    
                    <p><strong>Active Popups:</strong></p>
                    <ul>
                        <li>Scroll 50%: "Wait! Don't Leave Empty Handed!" (SCROLL15 - 15% off)</li>
                        <li>Time-based: Various test popups with 5-second delays</li>
                    </ul>
                `;

                addResult('üß™ Next Steps', testContent, 'info');

            } catch (error) {
                addResult('‚ùå Installation Failed', error.message, 'error');
            }
        }

        function testStore() {
            const storeUrl = `https://${SHOP_DOMAIN}/`;
            window.open(storeUrl, '_blank');
            addResult('üåê Store Opened', 
                `Opened <a href="${storeUrl}" target="_blank">${SHOP_DOMAIN}</a> in a new tab.<br><br>
                Look for popups and check the browser console for SmartPop logs!`, 
                'info');
        }

        // Initialize
        document.getElementById('script-url').textContent = SCRIPT_URL;
    </script>
</body>
</html>