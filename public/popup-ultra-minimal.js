(function(){const h=location.hostname,p=location.pathname;if(h==='admin.shopify.com'||p.includes('/admin')||p.includes('/apps')||p.includes('/install')||p.includes('/auth')||window!==top)return;let campaigns=[],active=null,sid=Date.now().toString(36)+Math.random().toString(36).substr(2),b={first:!localStorage.getItem('smartpop_visited'),time:0,scroll:0,exit:false};async function load(){try{const r=await fetch(`https://zsmoutzjhqjgjehaituw.supabase.co/functions/v1/popup-config?shop=${h}`);campaigns=(await r.json()).campaigns||[]}catch(e){}}function track(){localStorage.setItem('smartpop_visited','1');setInterval(()=>b.time++,1000);let t=false;addEventListener('scroll',()=>{if(!t){requestAnimationFrame(()=>{b.scroll=Math.max(b.scroll,(scrollY/(document.body.scrollHeight-innerHeight))*100||0);t=false});t=true}},{passive:true});document.addEventListener('mouseleave',e=>e.clientY<=0&&(b.exit=true))}function check(){if(active||!campaigns.length)return;const c=campaigns.find(c=>{const t=c.triggers;return!(t.isFirstVisit&&!b.first)&&!(t.timeOnSite&&b.time<t.timeOnSite)&&!(t.scrollDepth&&b.scroll<t.scrollDepth)&&!(t.hasExitIntent&&!b.exit)});c&&show(c)}function show(c){active=c;track2('view',{campaignId:c.id});const o=document.createElement('div');o.style.cssText='position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.5);font-family:sans-serif';const d=document.createElement('div');d.style.cssText='max-width:400px;padding:24px;border-radius:12px;background:white;position:relative';d.innerHTML=`<button style="position:absolute;top:16px;right:16px;background:none;border:none;font-size:24px;cursor:pointer">&times;</button><h2 style="margin:0 0 8px;font-size:24px">${c.title}</h2><p style="margin:0 0 16px;opacity:.8">${c.subtitle||''}</p>${c.discount_percent?`<div style="background:#10b981;color:white;border-radius:20px;padding:8px 16px;display:inline-block;margin-bottom:16px;font-weight:600">${c.discount_percent}% OFF</div>`:''}
<form style="display:flex;flex-direction:column;gap:12px"><input type="email" placeholder="Enter email" required style="padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px"><button type="submit" style="background:#3b82f6;color:white;padding:12px;border:none;border-radius:6px;font-size:16px;cursor:pointer">Get Discount</button></form>`;o.appendChild(d);document.body.appendChild(o);const close=()=>{o.remove();active=null};d.querySelector('button').onclick=close;o.onclick=e=>e.target===o&&close();d.querySelector('form').onsubmit=async e=>{e.preventDefault();const email=d.querySelector('input').value;if(email){await track2('conversion',{campaignId:c.id,email,discountCode:c.discount_code});d.innerHTML=`<div style="text-align:center;padding:40px 20px"><div style="width:64px;height:64px;background:#10b981;border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 16px;color:white;font-size:24px">âœ“</div><h3 style="margin:0 0 8px;font-size:20px">Thank You!</h3>${c.discount_code?`<p style="margin:0 0 16px">Code: <strong>${c.discount_code}</strong></p>`:''}
</div>`;c.discount_code&&navigator.clipboard?.writeText(c.discount_code);setTimeout(()=>{o.remove();active=null},3000)}}}async function track2(event,data){try{await fetch(`https://zsmoutzjhqjgjehaituw.supabase.co/functions/v1/popup-track`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({shop:h,event,sessionId:sid,pageUrl:location.href,...data})})}catch(e){}}async function init(){await load();track();setInterval(check,1000)}document.readyState==='loading'?document.addEventListener('DOMContentLoaded',init):init()})();